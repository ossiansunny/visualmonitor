#!/bin/bash
htdocs=$1
kanshibin="${htdocs}/bin"
path="${htdocs}/plot"
imgpath="${path}/plotimage"
hostall=`grep Target ${htdocs}/mrtg/newmrtg.cfg | awk 'BEGIN{FS="\`"}{print $2}' | awk '{print $2}'`
host=`echo "${hostall[@]}" | sort -u`
for file in ${host[@]}
do
  fsw=0
  while read tme cpu ram dsk
  do
    #echo "host:$file cpu:$cpu ram:$ram disk:$dsk"
    if [ $fsw -eq 0 ]
    then
      fsw=1
      rm -f ${imgpath}/${file}.ad
      touch ${imgpath}/${file}.ad
      chmod 777 ${imgpath}/${file}.ad 
      rm -f ${imgpath}/${file}.exe
      oldtme=$tme
      maxcpu=$cpu
      maxram=$ram
      maxdsk=$dsk
    else
      if [ $oldtme == $tme ]
      then
        if [ $maxcpu -lt $cpu ]
        then
          maxcpu=$cpu
        fi
        if [ $maxram -lt $ram ]
        then
          maxram=$ram
        fi
        if [ $maxdsk -lt $dsk ]
        then
          maxdsk=$dsk
        fi
      else
        echo "$oldtme $maxcpu $maxram $maxdsk" >> ${imgpath}/${file}.ad
        maxcpu=$cpu
        maxram=$ram
        maxdsk=$dsk
        oldtme=$tme
      fi
    fi
  done < ${imgpath}/${file}.log
  echo "$oldtme $maxcpu $maxram $maxdsk"  >> ${imgpath}/${file}.ad
  wcc=`wc -l ${imgpath}/${file}.ad | awk '{print $1}'`
  wccopt="-$wcc"
  if [ $wcc -lt 36 ]
  then
    tail $wccopt ${imgpath}/${file}.ad > ${imgpath}/${file}.ok
  else
    tail -36 ${imgpath}/${file}.ad > ${imgpath}/${file}.ok
  fi
  #pargs="path=\"${imgpath}\""
  #gargs="ghost=\"${file}\""
  #echo $pargs
  #echo $garps
  echo "/usr/bin/gnuplot -e 'path="\"${imgpath}\""; ghost="\"${file}\""' ${kanshibin}/mkplot.plt" > ${imgpath}/${file}.exe
  #echo $file
done
for file in ${host[@]}
do
  chmod +x ${imgpath}/${file}.exe
  ${imgpath}/${file}.exe
done
# adjust 432 lines
wcc=`wc -l ${imgpath}/${file}.log | awk '{print $1}'`
if [ $wcc -lt 432 ]
then
  cp ${imgpath}/${file}.log  ${imgpath}/${file}.logx
else
  tail -432 ${imgpath}/${file}.log > ${imgpath}/${file}.logx
fi
mv ${imgpath}/${file}.logx ${imgpath}/${file}.log
